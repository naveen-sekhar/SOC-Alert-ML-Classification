name: CD - Deploy to Hugging Face Space

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-space:
    runs-on: ubuntu-latest
    env:
      HF_SPACE_ID: ${{ secrets.HF_SPACE_ID }} # e.g. org-or-user/your-space
      HF_TOKEN: ${{ secrets.HF_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Hugging Face CLI
        run: |
          python -m pip install --upgrade pip
          pip install -U "huggingface_hub[cli]"

      - name: Validate inputs
        run: |
          if [ -z "${HF_SPACE_ID}" ]; then echo "HF_SPACE_ID secret not set"; exit 1; fi
          if [ -z "${HF_TOKEN}" ]; then echo "HF_TOKEN secret not set"; exit 1; fi

      - name: Ensure Space exists (gradio)
        env:
          HF_SPACE_ID: ${{ env.HF_SPACE_ID }}
          HF_TOKEN: ${{ env.HF_TOKEN }}
        run: |
          python - << 'PY'
          import os
          from huggingface_hub import HfApi
          api = HfApi(token=os.environ['HF_TOKEN'])
          repo_id = os.environ['HF_SPACE_ID']
          # Create if missing (public gradio Space). Set private=True if needed.
          api.create_repo(repo_id=repo_id, repo_type="space", space_sdk="gradio", private=False, exist_ok=True)
          PY

      - name: Stage Space payload
        run: |
          set -euo pipefail
          rm -rf space_payload && mkdir -p space_payload
          # App/runtime files
          cp -r hf/space_app/* space_payload/
          # Include trained model artifacts (prefer models/ layout)
          if [ -d models/catboost_models ]; then
            cp -r models/catboost_models space_payload/catboost_models
          fi
          if [ -d models/catboost_action_improved ]; then
            cp -r models/catboost_action_improved space_payload/catboost_action_improved
          fi

      - name: Upload to Space root
        env:
          HF_SPACE_ID: ${{ env.HF_SPACE_ID }}
          HF_TOKEN: ${{ env.HF_TOKEN }}
        run: |
          set -euo pipefail
          hf upload "${HF_SPACE_ID}" ./space_payload . --repo-type=space --commit-message "Sync Space app + models from CI/CD"
