name: ci-cd

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install -r hf/space_app/requirements.txt

      - name: Run metrics (confusion matrices + reports)
        run: |
          python src/evaluate_metrics.py --input data/smart_siem_dataset.csv --output-dir data/metrics

      - name: Plot confusion matrices
        run: |
          python src/plot_confusion_matrices.py --input data/smart_siem_dataset.csv --output-dir data/metrics

      - name: Upload metrics artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: metrics
          path: |
            data/metrics/*.csv
            data/metrics/*.txt
            data/metrics/*.png

  push-space:
    needs: test
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' }}
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      HF_SPACE_ID: ${{ secrets.HF_SPACE_ID }}
      HF_MODEL_REPO: ${{ secrets.HF_MODEL_REPO }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uploader deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install huggingface_hub>=0.20.0

      - name: Upload Space app to Hugging Face
        if: ${{ env.HF_TOKEN != '' && env.HF_SPACE_ID != '' }}
        run: |
          python - <<'PY'
          import os
          from huggingface_hub import upload_folder

          token = os.environ["HF_TOKEN"]
          space_id = os.environ["HF_SPACE_ID"]  # e.g., username/space-name
          upload_folder(
              folder_path="hf/space_app",
              repo_id=space_id,
              repo_type="space",
              token=token,
              allow_patterns=["**"],
          )
          print(f"Uploaded Space assets to {space_id}")
          PY

      - name: Upload model artifacts to Hub (optional)
        if: ${{ env.HF_TOKEN != '' && env.HF_MODEL_REPO != '' }}
        run: |
          python - <<'PY'
          import os
          from huggingface_hub import upload_folder

          token = os.environ["HF_TOKEN"]
          repo_id = os.environ["HF_MODEL_REPO"]  # e.g., username/soc-alert-models

          for folder in ["catboost_models", "catboost_action_improved"]:
              if not os.path.isdir(folder):
                  print(f"Skip missing folder: {folder}")
                  continue
              upload_folder(
                  folder_path=folder,
                  repo_id=repo_id,
                  repo_type="model",
                  token=token,
                  allow_patterns=["**"],
              )
              print(f"Uploaded {folder} to {repo_id}")
          PY
